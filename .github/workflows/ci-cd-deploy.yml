name: CI-CD Deploy

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install deps
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run tests
              id: run-tests
              run: |
                  pip install -e .
                  pytest -q
        outputs:
            tests_passed: ${{ steps.run-tests.outcome }}

    deploy:
        needs: test
        if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Prepare SSH key
              uses: webfactory/ssh-agent@v0.9.1
              with:
                  ssh-private-key: ${{ secrets.AZURE_SSH_KEY }}

            - name: Add Azure VM to known hosts
              run: |
                  ssh-keyscan -H ${{ secrets.AZURE_HOST }} >> ~/.ssh/known_hosts
            - name: Sync repo to Azure VM
              run: |
                  rsync -avz --delete --exclude '.git' ./ ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }}:${{ secrets.AZURE_DEPLOY_PATH }}

            - name: Copy .env to remote
              run: |
                  # Build .env content on the runner and send to remote
                  echo "FLASK_ENV=production" > ./ci_env
                  echo "SECRET_KEY=${{ secrets.FLASK_SECRET_KEY }}" >> ./ci_env
                  echo "OPENWEATHER_API_KEY=${{ secrets.OPENWEATHER_API_KEY }}" >> ./ci_env
                  rsync ./ci_env ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }}:${{ secrets.AZURE_DEPLOY_PATH }}/.env
            - name: Run remote deploy script
              run: |
                  ssh ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }} 'bash -s' < deploy/remote_deploy.sh ${{ secrets.AZURE_DEPLOY_PATH }}
